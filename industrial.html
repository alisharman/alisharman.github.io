<!DOCTYPE html>
<meta charset="utf-8">
<style>


/* BASIC HTML
========================================================*/
body {
  background-color: #f7f7f7;
  color: #666;
  font-size: 45%;
  line-height: 1.5;
  font-family: 'PT Serif', serif;
  -webkit-font-smoothing: antialiased;
}

::selection {
  background: #ffc;
}

/* FONT STUFF, LINKS, LISTS & TABLES
========================================================*/
h1, h2, h3, h4, h5, h6 {
  color: #333; 
  line-height: 1.2;
  margin-bottom: 10px;
}
h1 {
  font-size: 3em;
  letter-spacing: -1px;
}
h2 { font-size: 4em; }
h3 { font-size: 2em; }
h4 { font-size: 2.4em; }

p {
	color: #333;
	padding: 10px;
	font-size: 2em;
}

#checkbox {
	font-size:12px;
	color: black;
	display:block;
}

label {
    display: block;
    padding-left: 15px;
    text-indent: -15px;
}

input {
  width: 13px;
  height: 13px;
  padding: 0;
  margin: 2;
  vertical-align: bottom;
  position: relative;
  top: -1px;
  *overflow: hidden;
}

header {
  display: inline-block;
  width: 420px;
  background: #ddd;
  position: absolute;
  left: 0;
  top: 0;
 
  border-right: 1px solid #bbb;
  text-align: left;
  padding: 10px;
  box-shadow: 1px 0 10px rgba(0,0,0,0.35),
              inset -1px 0 1px rgba(255,255,255,0.4);
}


header h1 {
  text-shadow: 0 1px 1px #fff;
}

a {
	font-size: 12px;
}

body {
  position:absolute;
  top:0;
  margin: 0;
}

path {
  stroke-linejoin: round;
}

div.tooltip {	
    position: absolute;			
    text-align: center;		
    width: 80px;					
    height: 20px;					
    padding: 1px;				
    font: 9px sans-serif;
    color:black;
    border: 0px;		
    border-radius: 2px;			
    pointer-events: none;
}

#cutoffbox {
	width:50px;
	text-align:right;
}

#checkbox {
	margin-top: 15px;
}

.subhead {
	font-size:14px;
	font-weight: bold;
}

.subtog {
	display: inline;
}

</style>
    <header>
      <a href="index.html">Home</a></li>
      <h1>Dots represent towns w/ total no. workers from all checked industries > cutoff.</h3>
      
	<input type="text" id="cutoffbox" value="1000">
	<button onclick="selectIndustries()">Update cutoff</button>

	<div id="checkbox">
		<label class="subhead"><input type="checkbox" onClick="toggle(this, 'all')" /> Toggle All</label><br/>

		
		

		<label class="subhead"><input type="checkbox" name="subtog" onChange="toggle(this, 'extr')" />Extraction</label>
		
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="051">Mining of hard coal</label>
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="052">Mining of lignite</label>
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="061">Extraction of crude petroleum</label>
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="062">Extraction of natural gas</label>
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="071">Mining of iron ores</label>
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="072">Mining of non-ferrous metal ores</label>
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="081">Quarrying of stone, sand and clay</label>
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="089">Mining and quarrying n.e.c.</label>
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="091">Support activities for petroleum and natural gas mining</label>
			<label><input type="checkbox"  name="extr" class="myCheckbox" value="099">Support activities for other mining and quarrying</label>


		

		<label class="subhead"><input type="checkbox" name="subtog" onChange="toggle(this, 'chem')" />Chemical Manufacturing</label>
			
			<label><input type="checkbox"  name="chem" class="myCheckbox" value="191">Manufacture of coke oven products</label>
			<label><input type="checkbox"  name="chem" class="myCheckbox" value="192">Manufacture of refined petroleum products</label>
			<label><input type="checkbox"  name="chem" class="myCheckbox" value="201">Manufacture of basic chemicals, fertilizer and nitrogen compounds, plastics and synthetic rubber in primary forms</label>
			<label><input type="checkbox"  name="chem" class="myCheckbox" value="202">Manufacture of other chemical products</label>
			<label><input type="checkbox"  name="chem" class="myCheckbox" value="210">Manufacture of pharmaceuticals, medicinal chemical and botanical products</label>
			<label><input type="checkbox"  name="chem" class="myCheckbox" value="222">Manufacture of plastics products</label>
			<label><input type="checkbox"  name="chem" class="myCheckbox" value="352">Manufacture of gas; distribution of gaseous fuels through mains</label>

		


		<label class="subhead"><input type="checkbox" name="subtog" onChange="toggle(this, 'metal')" />Manufacturing w/ Metals and Minerals</label>
		
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="239">Manufacture of non-metallic mineral products n.e.c.</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="241">Manufacture of basic iron and steel</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="242">Manufacture of basic precious and other non-ferrous metals</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="243">Casting of metals</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="251">Manufacture of structural metal products, tanks, reservoirs and steam generators</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="252">Manufacture of weapons and ammunition</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="259">Manufacture of other fabricated metal products; metalworking service activities</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="271">Manufacture of electric motors, generators, transformers and electricity distribution and control apparatus</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="272">Manufacture of batteries and accumulators</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="281">Manufacture of general purpose machinery</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="282">Manufacture of special-purpose machinery</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="291">Manufacture of motor vehicles</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="292">Manufacture of bodies (coachwork) for motor vehicles; manufacture of trailers and semi-trailers</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="293">Manufacture of parts and accessories for motor vehicles</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="302">Manufacture of railway locomotives and rolling stock</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="303">Manufacture of air and spacecraft and related machinery</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="304">Manufacture of weapons and ammunition (tanks and vehicles)</label>
			<label><input type="checkbox"  name="metal" class="myCheckbox" value="309">Manufacture of transport equipment n.e.c.</label>	

		


		<label class="subhead"><input type="checkbox" name="subtog" onChange="toggle(this, 'other')" />Glass, Rubber, Paper, Leather, Medical supplies</label>
		
			<label><input type="checkbox"  name="other" class="myCheckbox" value="151">Tanning and dressing of leather; manufacture of luggage, handbags, saddlery and harness; dressing and dyeing of fur</label>
			<label><input type="checkbox"  name="other" class="myCheckbox" value="170">Manufacture of paper and paper products</label>
			<label><input type="checkbox"  name="other" class="myCheckbox" value="221">Manufacture of rubber products</label>
			<label><input type="checkbox"  name="other" class="myCheckbox" value="231">Manufacture of glass and glass products</label>
			<label><input type="checkbox"  name="other" class="myCheckbox" value="325">Manufacture of medical and dental instruments and supplies</label>




		<label class="subhead"><input type="checkbox" name="subtog" onChange="toggle(this, 'tex')" />Textiles</label>

			<label><input type="checkbox"  name="tex" class="myCheckbox" value="139">Manufacture of other textiles</label>
			<label><input type="checkbox"  name="tex" class="myCheckbox" value="141">Manufacture of wearing apparel, except fur apparel</label>
			<label><input type="checkbox"  name="tex" class="myCheckbox" value="203">Manufacture of man-made fibres</label>
			<label><input type="checkbox"  name="tex" class="myCheckbox" value="131">Spinning, weaving and finishing of textiles</label>




		<label class="subhead"><input type="checkbox" name="subtog" onChange="toggle(this, 'elec')" />Electrical</label>

			<label><input type="checkbox"  name="elec" class="myCheckbox" value="351">Electric power generation, transmission and distribution</label>
			<label><input type="checkbox"  name="elec" class="myCheckbox" value="261">Manufacture of electronic components</label>
			<label><input type="checkbox"  name="elec" class="myCheckbox" value="262">Manufacture of computers and peripheral equipment</label>
			<label><input type="checkbox"  name="elec" class="myCheckbox" value="263">Manufacture of communication equipment</label>
			<label><input type="checkbox"  name="elec" class="myCheckbox" value="264">Manufacture of consumer electronics</label>
			<label><input type="checkbox"  name="elec" class="myCheckbox" value="266">Manufacture  of irradiation,  electromedical  and  electrotherapeutic equipment</label>
			<label><input type="checkbox"  name="elec" class="myCheckbox" value="273">Manufacture of wiring and wiring devices</label>
			<label><input type="checkbox"  name="elec" class="myCheckbox" value="274">Manufacture of electric lighting equipment</label>
			<label><input type="checkbox"  name="elec" class="myCheckbox" value="275">Manufacture of domestic appliances</label>
			<label><input type="checkbox"  name="elec" class="myCheckbox" value="279">Manufacture of other electrical equipment</label>



		<label class="subhead"><input type="checkbox" name="subtog" onChange="toggle(this, 'agr')" />Agricultural Products Processing</label>
		
			<label><input type="checkbox"  name="agr" class="myCheckbox" value="101">Processing and preserving of meat</label>
			<label><input type="checkbox"  name="agr" class="myCheckbox" value="120">Manufacture of tobacco products</label>
			<label><input type="checkbox"  name="agr" class="myCheckbox" value="104">Manufacture of vegetable and animal oils and fats</label>
			<label><input type="checkbox"  name="agr" class="myCheckbox" value="105">Manufacture of dairy products</label>
			<label><input type="checkbox"  name="agr" class="myCheckbox" value="106">Manufacture of grain mill products, starches and starch products</label>
			<label><input type="checkbox"  name="agr" class="myCheckbox" value="110">Manufacture of beverages</label>


	</div>
    <div id="content"></div>
    </header>
<body>

<svg></svg>

<script src="//d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/d3-tile.v0.0.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script>

function toggle(source,nm) {
  if(nm=='all') {
  	checkboxes = document.getElementsByClassName('myCheckbox');
  	checkboxes2 = document.getElementsByName('subtog');
	for(var i=0, n=checkboxes2.length;i<n;i++) {
	  checkboxes2[i].checked = source.checked;
	}  	
  }
  else {checkboxes = document.getElementsByName(nm);}
  for(var i=0, n=checkboxes.length;i<n;i++) {
    checkboxes[i].checked = source.checked;
  }
  selectIndustries()
}

function selectIndustries(){
	var cutoff = document.getElementById("cutoffbox").value;
	var choices = [];
	d3.selectAll(".myCheckbox").each(function(d){
	  cb = d3.select(this);
	  if(cb.property("checked")){
	    choices.push('polemp_'+cb.property("value"));
	  }
	});
	dataMaps(choices, cutoff)
}

function updateData(ind) {
	var zoom = d3.zoom()
	    .scaleExtent([1 << 11, 1 << 20])
	    .on("zoom", zoomed);
	svg
	  //.call(zoom)
	  .call(zoom.transform, d3.zoomIdentity
	      .translate(width/2, (height/2))
	      .scale(5 << 11)
	      .translate(-center[0], -center[1]));

	function zoomed() {
	  var transform = d3.event.transform;
	  projection
	      .scale(transform.k / tau)
	      .translate([transform.x, transform.y]);
	   d3.selectAll("circle").remove()
	   d3.selectAll("line.link").remove()
	   d3.selectAll("path").remove()
	   d3.selectAll("marker").remove()
	   setupMap();
	   selectIndustries();
	}
}

// Run update function when dropdown selection changes
function setupMap() {
	d3.json("states.geojson", (error, stgeo) => {
		if (error) throw error;

		//add polygons	
		polys = map.selectAll("path")
			.attr("class", "states")
			.data(stgeo.features)
			.enter()
			.append("path")
			.style("fill", "white")
			.style("stroke", "black")
			.style("stroke-width", 1.2)
			.style("fill-opacity",0)
			.attr("d", path);
	});
}

function dataMaps(choices,cutoff) {
	d3.queue()
	  .defer(d3.csv, "ind_town_points.csv")
	  .await(drawMaps);

	function drawMaps(error, data) {
		if (error) throw error;

		//prepare data
	    var summed = d3.nest()
	        .key(d=>d.statetownid)
	        .rollup( function(v) { 
	        	return {
			        "x" : v[0]["x"],
			        "y" : v[0]["y"],
			        "total": d3.sum(v, function(d) { 
			        	var s = 0;
			        	for (var c in choices) {s = s + (+d[choices[c]]);};
			        	return s
			    	})
		    	};
		    })
	        .entries(data);
	    
		points = summed.filter(d=>d.value["total"]>cutoff);

		// add circles to svg
		d3.selectAll("circle").remove()
	    map.selectAll("circle")
		.data(points).enter().append("circle")
			.attr("id",d=>"n"+d.statetownid)
			.attr("cx", function (d) {return projection([d.value.x,d.value.y])[0]; })
			.attr("cy", function (d) { return projection([d.value.x,d.value.y])[1]; })
			.attr("r", "3px")
			.style("stroke", "#400000")
			.style("fill", "red");
	};
}


var pi = Math.PI,
    tau = 2 * pi;

var width = Math.max(1200, window.innerWidth),
    height = Math.max(1000, window.innerHeight);

// Initialize the projection to fit the world in a 1Ã—1 square centered at the origin.
var projection = d3.geoMercator()
    .scale(1 / tau)
    .translate([0, 0]);

var path = d3.geoPath()
    .projection(projection);

var tile = d3.tile()
    .size([width, height]);

var svg = d3.select("svg")
    .attr("width", width)
    .attr("height", height);

var colorScale = d3.scaleOrdinal(d3.schemeCategory10);

var raster = svg.append("g");
var map = svg.append("g");
var div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);

var center = projection([78, 21]);




d3.selectAll(".myCheckbox").on("change",selectIndustries);
selectIndustries();
setupMap();
updateData("pollution_emp_all",1000);



</script>
</body>